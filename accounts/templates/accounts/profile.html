{% extends "call.html" %}

{% load static i18n bootstrap3 %}

{% block css %}
<link href="{% static 'css/cropper.min.css' %}" rel="stylesheet"> 
<script src="https://use.fontawesome.com/658bb4caf7.js"></script>   
{% endblock css %}


{% block main %}

<div class="container">
  <div class="col-xs-12 profile">
    <div class="ibox float-e-margins">
        {# FORM TITLE #}
        <div class="ibox-title">
            <h2> {% trans "Profile" %}<small> {% trans "please update picture." %}</small></h2>
            <div class="ibox-tools">
            </div>
        </div>
        {# FORM CONTENT #}
        <div class="ibox-content">
            {# FORM START #}
            <form method="POST" enctype='multipart/form-data' class="form-horizontal" id="formProfile">
                
                {% csrf_token %}
                {% bootstrap_form form %}
                <div class="preview">
                  <div class="upload">
                    <span class="preview-bg"></span>
                    
                    <img src="{% if user.profile.picture %} {{ user.profile.picture.url }} {% else %} {% static 'images/nouser.png' %}{% endif %}" 
                style="border-radius: 5px; margin-bottom: 1em;" width="150" id='image_existed'>
                  </div>
                </div>
                <input type="submit" class='btn btn-primary btn-lg btn-block' value='Confirm' id="btn-profile" style="display: none;">
            </form>
        </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="col-xs-12 pictures">
    <div class="col-xs-6">
        Anchor Url 
    </div>
    <div class="col-xs-6">
        # {{ user.profile.positions_count }}
    </div>
  </div>
  <div class="col-xs-12 pictures">
    <div class="col-xs-6">
        Pictures 
    </div>
    <div class="col-xs-6">
        # {{ user.profile.pictures_count }}
    </div>
  </div>
</div>

{% endblock main %}

{% block modal %}
<div class="modal fade" id="modalCrop">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" type='button' data-dismiss='modal' aria-label='Close'>
                    <span aria-hidden='true'>&times;</span>
                </button>
                <h4 class="modal-title">{% trans "Crop the photo" %} </h4>
            </div>
            <div class="modal-body">
                <img src="" id='image' style='max-width: 100%'>
            </div>
            <div class="modal-footer">
                <div class="btn-group pull-left" role='group'>
                    <button type='button' class="btn btn-default js-zoom-in">
                        <i class="icon-zoom-out icon-3"></i>  
                    </button>
                    <button type='button' class="btn btn-default js-zoom-out">
                        <i class="icon-zoom-in icon-3"></i>
                    </button>
                </div>
                <button type='button' class="btn btn-default" data-dismiss='modal'>Cancel</button>
                <button type='button' class="btn btn-primary btn-crop" data-dismiss='modal'>{% trans "Crop and Upload" %}</button>
            </div>
        </div>
    </div>
</div> 
{% endblock modal %}

{% block javascript %}
<script src="{% static 'js/cropper.min.js' %}"></script>
<script>

$(function(){
// SCRIPT TO OPEN the MODAL With the Preview
    $('#id_picture').change(function() {
        if(this.files && this.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#image').attr('src', e.target.result);
                $('#modalCrop').modal("show");
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    // SCRIPTS TO HANDLE THE CROPPER BOX
    var $image = $('#image');
    var cropBoxData;
    var canvasData;

    $('#modalCrop').on('shown.bs.modal', function(){
        $image.cropper({
            viewMode: 1,
            aspectRatio: 1/1,
            minCropBoxWidth: 200,
            minCropBoxHeight: 200,
            ready: function(){
                $image.cropper('setCanvasData', canvasData);
                $image.cropper('setCropBoxData', cropBoxData);
            }
        });
    }).on('hidden.bs.modal', function(){
        cropBoxData = $image.cropper('getCropBoxData');
        canvasData = $image.cropper('getCanvasData');
        $image.cropper('destory');
    });

    $(".js-zoom-in").click(function(){
        $image.cropper('zoom', 0.1);
    })
    $(".js-zoom-out").click(function(){
        $image.cropper('zoom', -0.1);
    });

    // SCRIPT TO COLLECT THE DATA AND POST TO THE SERVER
    $('.btn-crop').click(function(){
        var cropData = $image.cropper('getData');
        $('#id_x').val(cropData['x']);
        $('#id_y').val(cropData['y']);
        $('#id_height').val(cropData['height']);
        $('#id_width').val(cropData['width']);

        var nickname = $("#id_nickname").val();
        if (nickname.length >= 2){
            $("#btn-profile").prop("disabled", true);
            $("#formProfile").submit();
        }
    });
});

$('#id_nickname').bind('input', function() { 
    $("#btn-profile").show();
});
</script>    
{% endblock javascript %}
