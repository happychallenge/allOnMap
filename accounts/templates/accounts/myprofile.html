{% extends "base.html" %}

{% load static i18n bootstrap3 %}

{% block css %}
<link href="{% static 'css/cropper.min.css' %}" rel="stylesheet">
<style>
.post-content img {
  border-radius: 50%;
}
.upload img{
    display: block;
    margin: 0 auto;
}
</style>
{% endblock css %}


{% block main %}

    <div class="comment-container">
      <div class="comment-header">
        <span class="user-name">
          {% trans "User name and Profile" %}  
        </span>
      </div>

    <form method="POST" enctype='multipart/form-data' class="form-horizontal" id="formProfile">
        {% csrf_token %}
      <div class="form-row-group with-icons">
        <div class="form-row no-padding">
          <i class="fa fa-vcard-o"></i>
          <input type="text" name="nickname" id="id_nickname" class="form-element" value="{{form.instance.nickname}}">
        </div>
      </div>

      <div class="form-divider"></div>
      <div class="form-row-group with-icons">
        <div class="form-row no-padding">
            <input type="file" name="picture" title="" accept="image/*" id="id_picture" class="">
            <div class="preview">
              <div class="upload">
                <span class="preview-bg"></span>
                <img src="{% if user.profile.picture %} {{ user.profile.picture.url }} {% else %} {% static 'images/nouser.png' %}{% endif %}" 
            style="border-radius: 5px; margin-bottom: 1em;" width="150" id='image_existed'>
              </div>
            </div>
            <input type="hidden" name="x" id="id_x">
            <input type="hidden" name="y" id="id_y">
            <input type="hidden" name="width" id="id_width">
            <input type="hidden" name="height" id="id_height">
        </div>
      </div>  


      <div class="form-row">
          <button id="btn-profile" type="submit" class="button circle block green" style="display: none;">{% trans "Confirm" %}</button>
      </div>
    </form>

    </div>  

{# Summary #}
    <div class="comment-container">
      <div class="comment-header">
        <span class="user-name">
          {% trans "User map and Pictures" %}  
        </span>
      </div>
      <div class="comment-content">
        # map : {{ user.profile.positions_count }} <br>
        # pictures : {{ user.profile.pictures_count }}
      </div>
    </div>

{# List of Map #}
    {% include 'onmap/position_mylist_ajax.html' %}

{% endblock main %}

{% block modal %}

<div class="popup-overlay" id="modalCrop"> <!-- if you dont want overlay add class .no-overlay -->
    <div class="popup-container">
        <div class="popup-header">
            <h3 class="popup-title">{% trans "Crop the photo" %}</h3>
            <span class="popup-close" data-dismiss="true"><i class="fa fa-times"></i></span>
        </div>
        <div class="popup-content">
            <img src="" id='image' style='max-width: 100%'>
        </div>
        <div class="popup-footer">
            <button class="button" data-dismiss="true">Cancel</button>
            <button class="button green btn-crop">{% trans "Crop and Upload" %}</button>
        </div>
    </div>
</div>

{% endblock modal %}

{% block javascript %}
<script src="{% static 'js/cropper.min.js' %}"></script>
<script>

$(function(){
// SCRIPT TO OPEN the MODAL With the Preview
    $('#id_picture').change(function() {
        if(this.files && this.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#image').attr('src', e.target.result);
                $('#modalCrop').fadeIn('fast');
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    // SCRIPTS TO HANDLE THE CROPPER BOX
    var $image = $('#image');
    var cropBoxData;
    var canvasData;

    $image.on('load', function(){
        $image.cropper({
            viewMode: 1,
            aspectRatio: 1 / 1,
            minCropBoxWidth: 200,
            minCropBoxHeight: 200,
            ready: function() {
                $image.cropper('setCanvasData', canvasData);
                $image.cropper('setCropBoxData', cropBoxData);
            },
        });
        cropData = $image.cropper('getData');
        console.log("first : "+cropData);
    }).on('fadeout', function() {
        cropBoxData = $image.cropper('getCropBoxData');
        canvasData = $image.cropper('getCanvasData');
        $image.cropper('destory');
    });;

    // $(".js-zoom-in").click(function(){
    //     $image.cropper('zoom', 0.1);
    // })
    // $(".js-zoom-out").click(function(){
    //     $image.cropper('zoom', -0.1);
    // });

    // SCRIPT TO COLLECT THE DATA AND POST TO THE SERVER
    $('.btn-crop').click(function(){
        var cropData = $image.cropper('getData');
        $('#id_x').val(cropData['x']);
        $('#id_y').val(cropData['y']);
        $('#id_height').val(cropData['height']);
        $('#id_width').val(cropData['width']);

        var nickname = $("#id_nickname").val();
        if (nickname.length >= 2){
            $("#btn-profile").prop("disabled", true);
            $("#formProfile").submit();
        }
    });
});

$('#id_nickname').bind('input', function() { 
    $("#btn-profile").show();
});
</script>    
{% endblock javascript %}
