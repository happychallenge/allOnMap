{% extends "base.html" %}
{% load static i18n humanize %}


{% block css %}
<link href="{% static 'css/custommarker.css' %}" rel="stylesheet"> 
<style>
#map{
  width: 100%;
  height: 600px;
}
.well {
  border: 1px solid #e7eaec;
  box-shadow: none;
  background-color: #ccc;
  margin-top: 5px;
  margin-bottom: 5px;
  padding: 10px 10px;
  font-size: 13px;
  line-height: 16px;
}
</style>
{% endblock css %}


{% block main %}

  {# Notification for Signup #}
    {% if not user.is_authenticated %}
    <div class="comment-container">
      <div class="comment-header">
        <span class="user-name">{% trans "Infomation" %}</span>
      </div>
      <div class="comment-content">
        <h4> {% trans "If you sign up, all records will be saved and available for future use." %}
        <a href="{% url 'login' %}"> 
          <button class="button darkblue">Sign Up</button> </a></h4>
      </div>
    </div>
    {% endif %}

  {# Positon Info #}

    <div class="post-item">
    {# Name #}
      <div class="post-header">
        <strong class="post-title">
          {{position.name}}
        </strong>
        <div>
          <span class="post-date"><i class="fa fa-clock-o"></i> {% trans "create time" %}: {{position.create_dt|naturaltime }} </span>
          <span class="post-comment">
            <i class="fa fa-comments"></i> {{position.views}} {% trans "viewed" %} &nbsp;&nbsp;&nbsp;
            <i class="fa fa-heart"></i> {{position.likes}} {% trans "likes" %}
          </span>
        </div>
      </div>
    {# Button #}
      <div class="post-content">
          <a href="{% url 'onmap:edit' position.slug %}" class="button circle darkblue"> {% trans "Edit" %} </a> 
          <button class="button circle red" data-url="{{position.slug}}"> {% trans "Delete" %} </a>
      </div> 
    {# Public #}
      <div class="post-content">
        <div class="list-box">
          <div class="list-item">
            <span>
              {% if position.public %}
                {% trans "You chose 'Public'" %}
              {% else %}
                {% trans "You chose 'Not Public'" %}
              {% endif %}
            </span>
            <div class="sweet-check {% if position.public %}checked{% endif %}">
              <input type="checkbox" {% if position.public %}checked{% endif %} >
              <div class="outline"> </div>
            </div> 
          </div>
        </div>
      </div>     
    {# Pictures #}
      <div class="post-content">
          {% for picture in position.pictures.all %}
              <img src="{{picture.file.url}}" alt="{{picture.name}}">
          {% endfor %}
      </div>   
    {# URL Copy #}
      <div class="post-content">
        <a href="http://{{ request.get_host }}{% url 'onmap:apicall' position.slug %}" target="_blank"> 
          <small>  http://{{ request.get_host }}{% url 'onmap:apicall' position.slug %} </small>
        </a> 
        <button class="button darkblue pull-right" onclick="copyToClipboard()">
          {% trans "Copy to clipboard" %}
        </button><br>
        <input type="text" id="id_copyurl" value="http://{{ request.get_host }}{% url 'onmap:apicall' position.slug %}" >
        <div class="well">
<pre>&lt;a href='http://{{ request.get_host }}{% url 'onmap:apicall' position.slug %}' 
target='_blank'&gt;
    &lt;img src='Picture Name' alt='{{position.name}}'&gt;
&lt;/a&gt;</pre>
        </div>
      </div> 
    {# Map #}
      <div class="post-content">
          <div id="map"></div>
      </div>
    </div> 

{% endblock main %}


{% block javascript %}

{% if china %}
  <script src="https://ditu.google.cn/maps/api/js?key=AIzaSyD03p1K9oToraWXg-EsjsV7I06xwKaQ1do"></script>
{% else %}
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD03p1K9oToraWXg-EsjsV7I06xwKaQ1do"></script>
{% endif %}

<script>

function CustomMarker(latlng, map, imageSrc) {
    this.latlng_ = latlng;
    this.imageSrc = imageSrc;
    // Once the LatLng and text are set, add the overlay to the map.  This will
    // trigger a call to panes_changed which should in turn call draw.
    this.setMap(map);
}

CustomMarker.prototype = new google.maps.OverlayView();

CustomMarker.prototype.draw = function () {
    // Check if the div has been created.
    var div = this.div_;
    if (!div) {
        // Create a overlay text DIV
        div = this.div_ = document.createElement('div');
        // Create the DIV representing our CustomMarker
        div.className = "customMarker"


        var img = document.createElement("img");
        img.src = this.imageSrc;
        div.appendChild(img);
        // google.maps.event.addDomListener(div, "click", function (event) {
        //     google.maps.event.trigger(me, "click");
        // });

        // Then add the overlay to the DOM
        var panes = this.getPanes();
        panes.overlayImage.appendChild(div);
    }

    // Position the overlay 
    var point = this.getProjection().fromLatLngToDivPixel(this.latlng_);
    if (point) {
        div.style.left = point.x + 'px';
        div.style.top = point.y + 'px';
    }
};

CustomMarker.prototype.remove = function () {
    // Check if the overlay was on the map and needs to be removed.
    if (this.div_) {
        this.div_.parentNode.removeChild(this.div_);
        this.div_ = null;
    }
};

CustomMarker.prototype.getPosition = function () {
    return this.latlng_;
};

var pictures = [
    {% for picture in position.pictures.all %}
        {id: {{picture.id}}, location: {lat: {{picture.lat}}, lng: {{picture.lng}} }, icon: '{{picture.file.url}}' },
    {% endfor %}
];

function initialize(){
    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 10,
        // center: new google.maps.LatLng(36.0078916666667, 128.260222222222),
    });

    var bounds = new google.maps.LatLngBounds();
    for (var i = 0; i < pictures.length; i++) {
        var position = new google.maps.LatLng( pictures[i].location );
        var id = pictures[i].id;
        var icon = pictures[i].icon;

        new CustomMarker(position, map, pictures[i].icon);

        bounds.extend(position);
        // console.log("Position Lat : " + position.lat() + " " + position.lng());
        // console.log("Bounds Lat :   " + bounds.f.b + " " + bounds.b.f );
    }
    map.fitBounds(bounds)
}

google.maps.event.addDomListener(window, 'load', initialize);
</script>

<script>
function copyToClipboard() {
  var copyText = document.getElementById("id_copyurl");
  copyText.select();
  document.execCommand("Copy");
  alert("Copied the url: " + copyText.value);
}
</script>

<script>
  
</script>

{% endblock javascript %}

